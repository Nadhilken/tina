<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teena - Your Personal Robot Assistant</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            text-align: center;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 90vh;
        }

        .header {
            margin-bottom: 30px;
            position: relative;
        }
        
        .menu-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .menu-button:hover {
            background-color: #f1f3f4;
        }

        .logo {
            max-width: 200px;
            margin-bottom: 20px;
        }

        .assistant-gif {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            cursor: pointer;
            margin: 20px auto;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .assistant-gif.listening {
            border-color: #4CAF50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
            transform: scale(1.05);
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 20px;
            margin: 20px 0;
        }

        .status {
            flex: 2;
            display: flex;
            flex-direction: column;
            min-height: 60px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: left;
        }

        #transcript {
            font-weight: bold;
            color: #1a73e8;
            margin-bottom: 10px;
        }

        #response {
            color: #333;
            line-height: 1.6;
        }

        .settings-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 300px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            text-align: left;
            display: none;
            border: 1px solid #dadce0;
        }

        .settings-panel h3 {
            margin-top: 0;
            color: #1a73e8;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input[type="text"],
        input[type="password"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 14px;
        }

        .api-key-input {
            font-family: 'Courier New', monospace;
        }

        .error {
            color: #d32f2f;
            margin-top: 5px;
            font-size: 13px;
        }

        .success {
            color: #388e3c;
            margin-top: 10px;
            font-weight: 500;
        }

        @media (max-width: 600px) {
            .container {
                margin: 20px;
                padding: 15px;
            }

            .controls {
                flex-direction: column;
            }

            button {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="static/images/logo.png" alt="I Robotics Logo" class="logo">
            <h1>Teena - Your Personal Robot Assistant</h1>
            <p>Created by I Robotics, Coimbatore - Developing the Future of Robotics</p>
            <button class="menu-button" id="menuButton">⚙️</button>
        </div>

        <div class="chat-container">
            <div class="status">
                <img src="static/images/assistant.gif" alt="Teena" class="assistant-gif" id="assistantGif">
                <div id="transcript">Click the assistant to start speaking...</div>
                <div id="response"></div>
            </div>
        </div>

        <div class="settings-panel" id="settingsPanel" style="display: none;">
            <h3>API Settings</h3>
            <div class="form-group">
                <label for="apiKey">Gemini API Key</label>
                <input type="password" id="apiKey" class="api-key-input" placeholder="Enter your Gemini API key">
                <div id="apiKeyError" class="error"></div>
                <div id="apiKeySuccess" class="success" style="display: none;">Settings saved successfully!</div>
            </div>
            <div class="form-group">
                <label for="model">AI Model</label>
                <select id="model">
                    <option value="gemini-2.0-flash">Gemini 2.0 Flash (Recommended)</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                </select>
            </div>
            <button id="saveSettingsBtn" class="primary-btn">Save Settings</button>
            <small>Get your API key from <a href="https://ai.google.dev/" target="_blank">Google AI Studio</a></small>
        </div>
    </div>

    <script>
        // DOM Elements
        const assistantGif = document.getElementById('assistantGif');
        const transcript = document.getElementById('transcript');
        const response = document.getElementById('response');
        const apiKeyInput = document.getElementById('apiKey');
        const apiKeyError = document.getElementById('apiKeyError');
        const apiKeySuccess = document.getElementById('apiKeySuccess');
        const modelSelect = document.getElementById('model');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');

        // State
        let isListening = false;
        let recognition;
        let apiKey = localStorage.getItem('geminiApiKey') || '';
        let selectedModel = localStorage.getItem('selectedModel') || 'gemini-2.0-flash';
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        
        // Teena's system prompt and context
        const SYSTEM_PROMPT = `You are Teena, a friendly robot assistant created by I Robotics, a company in Coimbatore that develops robots. 
        You should respond concisely in about 15 tokens. Keep your responses short, friendly, and to the point. 
        Your responses should be helpful and professional, representing I Robotics.
        
        Context:
        - You are a robot named Teena
        - Created by I Robotics, a company in Coimbatore
        - You are a personal robot assistant
        - Keep responses brief (around 15 tokens)
        - Be helpful, friendly, and professional`;

        // Toggle settings panel
        function toggleSettings() {
            const settingsPanel = document.getElementById('settingsPanel');
            if (settingsPanel.style.display === 'block') {
                settingsPanel.style.display = 'none';
            } else {
                // Load current settings
                document.getElementById('apiKey').value = localStorage.getItem('geminiApiKey') || '';
                document.getElementById('model').value = localStorage.getItem('selectedModel') || 'gemini-2.0-flash';
                settingsPanel.style.display = 'block';
            }
        }

        // Close settings when clicking outside
        document.addEventListener('click', (event) => {
            const settingsPanel = document.getElementById('settingsPanel');
            const menuButton = document.getElementById('menuButton');
            if (settingsPanel.style.display === 'block' && 
                !settingsPanel.contains(event.target) && 
                event.target !== menuButton && 
                !menuButton.contains(event.target)) {
                settingsPanel.style.display = 'none';
            }
        });

        // Initialize
        function init() {
            // Set up menu button
            document.getElementById('menuButton').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleSettings();
            });
            
            // Set up save button
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            // Add welcome message if first time
            if (chatHistory.length === 0) {
                const welcomeMessage = "Hello! I'm Teena, your personal robot assistant from I Robotics. How can I help you today?";
                addToChatHistory('bot', welcomeMessage);
                document.getElementById('response').textContent = welcomeMessage;
            }
            // Load saved settings
            if (apiKey) {
                apiKeyInput.value = apiKey;
            }
            modelSelect.value = selectedModel;

            // Check for browser support
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                transcript.textContent = 'Speech recognition is not supported in this browser. Please use Chrome, Edge, or Safari.';
                return;
            }

            // Initialize speech recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            // Event Listeners
            assistantGif.addEventListener('click', toggleListening);
            saveSettingsBtn.addEventListener('click', saveSettings);

            // Speech recognition event handlers
            recognition.onstart = () => {
                isListening = true;
                transcript.textContent = 'Listening...';
                assistantGif.src = 'static/images/listening.gif';
            };
            
            recognition.onend = () => {
                isListening = false;
                if (transcript.textContent === 'Listening...') {
                    transcript.textContent = 'Click the assistant to start speaking...';
                }
                assistantGif.src = 'static/images/assistant.gif';
            };

            recognition.onresult = async (event) => {
                const question = event.results[0][0].transcript;
                transcript.textContent = `You asked: ${question}`;
                response.textContent = 'Thinking...';
                
                try {
                    const answer = await getGeminiResponse(question);
                    response.innerHTML = formatResponse(answer);
                    speakResponse(answer);
                } catch (error) {
                    console.error('Error:', error);
                    response.textContent = 'Sorry, I encountered an error. Please try again.';
                }
            };

            recognition.onend = () => {
                isListening = false;
                assistantGif.classList.remove('listening');
                startBtn.innerHTML = '<span>Start Listening</span>';
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                assistantGif.classList.remove('listening');
                startBtn.innerHTML = '<span>Start Listening</span>';
                
                let errorMessage = 'Error occurred in recognition. ';
                switch(event.error) {
                    case 'no-speech':
                        errorMessage = 'No speech was detected.';
                        break;
                    case 'audio-capture':
                        errorMessage = 'No microphone was found.';
                        break;
                    case 'not-allowed':
                        errorMessage = 'Permission to use microphone was denied.';
                        break;
                    default:
                        errorMessage += event.error;
                }
                transcript.textContent = errorMessage;
            };
        }

        // Toggle listening state
        function toggleListening() {
            if (!apiKey) {
                transcript.textContent = 'Please set your Gemini API key in settings first.';
                settingsPanel.style.display = 'block';
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
                response.textContent = '';
                recognition.start();
            }
        }

        // Toggle settings panel
        function toggleSettings() {
            const currentDisplay = settingsPanel.style.display;
            settingsPanel.style.display = currentDisplay === 'block' ? 'none' : 'block';
        }

        // Save settings
        function saveSettings() {
            const newApiKey = apiKeyInput.value.trim();
            const newModel = modelSelect.value;

            if (!newApiKey) {
                apiKeyError.textContent = 'API key is required';
                return;
            }

            apiKey = newApiKey;
            selectedModel = newModel;

            localStorage.setItem('geminiApiKey', apiKey);
            localStorage.setItem('selectedModel', selectedModel);

            apiKeyError.textContent = '';
            apiKeySuccess.style.display = 'block';
            document.getElementById('settingsPanel').style.display = 'none';

            // Add welcome message if this is the first time
            if (chatHistory.length === 0) {
                const welcomeMessage = "Hello! I'm Teena, your personal robot assistant from I Robotics. How can I help you today?";
                addToChatHistory('bot', welcomeMessage);
            }

            setTimeout(() => {
                apiKeySuccess.style.display = 'none';
            }, 3000);
        }

        // Add message to chat history
        function addToChatHistory(role, message) {
            const chatMessage = {
                role: role,
                content: message,
                timestamp: new Date().toISOString()
            };
            chatHistory.push(chatMessage);
            
            // Keep only the last 20 messages to maintain context without using too many tokens
            if (chatHistory.length > 20) {
                chatHistory = chatHistory.slice(-20);
            }
            
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }
        
        // Format chat history for context
        function getChatContext() {
            if (chatHistory.length === 0) return '';
            
            return chatHistory.map(msg => {
                return `${msg.role === 'user' ? 'User' : 'Teena'}: ${msg.content}`;
            }).join('\n');
        }

        // Get response from Gemini API
        async function getGeminiResponse(question) {
            if (!apiKey) {
                throw new Error('API key not set');
            }
            
            // Add user's question to chat history
            addToChatHistory('user', question);
            
            // Get conversation context
            const context = getChatContext();
            
            // Prepare the prompt with context
            const prompt = `${SYSTEM_PROMPT}\n\nCurrent conversation:\n${context}\n\nUser: ${question}\nTeena:`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 50, // Limit to about 15 words
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_NONE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_NONE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_NONE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_NONE"
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Failed to get response from Gemini API');
                }

                const data = await response.json();
                let responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || 'I apologize, but I cannot process that request at the moment.';
                
                // Clean up the response and ensure it's concise
                responseText = responseText.trim();
                
                // Remove any trailing colons or other artifacts
                responseText = responseText.replace(/^Teena:\s*/i, '').trim();
                
                // Add bot's response to chat history
                addToChatHistory('bot', responseText);
                
                return responseText;
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                throw new Error(`Error: ${error.message}`);
            }
        }

        // Format the response with proper line breaks and formatting
        function formatResponse(text) {
            // Replace markdown headers with HTML
            text = text.replace(/^#\s+(.+)$/gm, '<h3>$1</h3>');
            // Replace markdown bold with HTML
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Replace markdown italics with HTML
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Replace markdown links with HTML
            text = text.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
            // Replace newlines with <br> for HTML display
            return text.replace(/\n/g, '<br>');
        }

        // Speak the response using the Web Speech API
        function speakResponse(text) {
            // Remove markdown formatting for speech
            const cleanText = text
                .replace(/[#*_[\]]/g, '') // Remove markdown formatting
                .replace(/\[(.*?)\]\(.*?\)/g, '$1'); // Remove markdown links, keep link text

            const speech = new SpeechSynthesisUtterance(cleanText);
            speech.lang = 'en-US';
            
            // Function to set the voice
            const setVoice = () => {
                const voices = window.speechSynthesis.getVoices();
                if (voices.length === 0) {
                    // If voices aren't loaded yet, try again after a short delay
                    setTimeout(setVoice, 100);
                    return;
                }

                const femaleVoice = voices.find(voice => 
                    voice.name.includes('Google US English Female') || 
                    voice.name.includes('Microsoft Zira') ||
                    voice.name.includes('Samantha') ||
                    voice.name.includes('Victoria') ||
                    voice.name.includes('Tessa') ||
                    (voice.lang === 'en-US' && voice.name.toLowerCase().includes('female'))
                ) || voices[0]; // Fall back to first available voice
                
                speech.voice = femaleVoice;
                window.speechSynthesis.speak(speech);
            };

            // Start the voice setting process
            setVoice();
        }

        // Initialize when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Preload voices
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => {
                    console.log('Voices loaded:', window.speechSynthesis.getVoices());
                };
            }

            // Initialize the app
            init();
        });
    </script>
</body>
</html>
