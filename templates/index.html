<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Q&A Website</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            margin: 0;
            padding: 0;
            color: #000000;
        }

        .container {
            max-width: 800px;
            margin: 100px auto 0;
            padding: 20px;
            text-align: center;
            background-color: #fff;
            border-radius: 8px;
        }

        .voice-section {
            background: #fff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        input[type="text"] {
            width: 80%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #555555;
            border-radius: 4px;
            background-color: #444444;
            color: #e0e0e0;
        }

        button {
            padding: 10px 20px;
            background-color: #696c6f;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #000000;
        }

        #transcript, #response, #formFeedback, #mediaFeedback {
            margin: 10px 0;
            font-size: 1.1em;
            color: #000000;
        }

        .menu-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #e0e0e0;
            z-index: 1000;
        }

        .menu-button:hover {
            color: #1a73e8;
        }

        .qa-menu {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            background: #333333;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 900;
        }

        .qa-menu.open {
            display: block;
        }

        .qa-menu h2, .qa-menu h3 {
            color: #e0e0e0;
            margin-top: 20px;
            font-size: 1.2em;
        }

        .qa-menu h3 {
            font-size: 1em;
            margin-bottom: 10px;
        }

        .qa-menu form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .qa-menu input[type="text"] {
            width: calc(100% - 22px);
        }

        .edit-qa-button {
            width: 100%;
            margin: 10px 0;
            background-color: #1a73e8;
            color: #ffffff;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        .edit-qa-button:hover {
            background-color: #1557b0;
        }

        .qa-list {
            margin-top: 20px;
            background: #444444;
            padding: 10px;
            border-radius: 4px;
        }

        .qa-item {
            display: flex;
            flex-direction: column;
            margin: 10px 0;
            padding: 10px;
            background: #555555;
            border-radius: 4px;
        }

        .qa-item span {
            text-align: left;
            color: #e0e0e0;
            margin-bottom: 5px;
        }

        .qa-item .qa-actions {
            display: flex;
            gap: 5px;
        }

        .qa-item input[type="text"] {
            width: calc(100% - 22px);
            margin: 5px 0;
        }

        .qa-item button {
            padding: 5px 10px;
            font-size: 0.9em;
        }

        .qa-item .edit-qa {
            background-color: #1a73e8;
        }

        .qa-item .edit-qa:hover {
            background-color: #1557b0;
        }

        .qa-item .delete-qa {
            background-color: #d32f2f;
        }

        .qa-item .delete-qa:hover {
            background-color: #b71c1c;
        }

        .qa-item .save-qa, .qa-item .cancel-qa {
            background-color: #4caf50;
        }

        .qa-item .save-qa:hover, .qa-item .cancel-qa:hover {
            background-color: #388e3c;
        }

        .qa-item .cancel-qa {
            background-color: #757575;
        }

        .qa-item .cancel-qa:hover {
            background-color: #616161;
        }

        .drop-area {
            border: 2px dashed #555555;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #444444;
            border-radius: 4px;
        }

        .drop-area.dragover {
            border-color: #1a73e8;
            background: #555555;
        }

        .media-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 5px;
            background: #444444;
            border-radius: 4px;
        }

        .media-item span {
            flex: 1;
            text-align: left;
            padding-left: 10px;
        }

        .media-item button {
            padding: 5px 10px;
            font-size: 0.9em;
            margin-left: 5px;
        }

        .media-item .delete-media {
            background-color: #d32f2f;
        }

        .media-item .delete-media:hover {
            background-color: #b71c1c;
        }

        .header-gif {
            max-width: 100%;
            height: auto;
            max-height: 400px;
            display: flex;
            margin: 0 auto 30px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            align-items: center;
            justify-content: center;
        }

        .header-gif:hover {
            opacity: 0.8;
            transform: scale(1.02);
        }

        .header-gif.listening {
            border: 3px solid #ff0000;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            background: linear-gradient(45deg, #ff6b6b, #ee5a52) !important;
        }

        .logo {
            position: fixed;
            top: 20px;
            left: 20px;
            max-height: 200px;
            width: auto;
            z-index: 1000;
        }

        .media-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }

        .media-modal.open {
            display: flex;
        }

        .media-container {
            max-width: 80%;
            max-height: 80%;
            position: relative;
        }

        #videoPlayer {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .slideshow {
            width: 100%;
            height: auto;
            text-align: center;
        }

        #slideshowImage {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 8px;
        }

        .slide-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: #e0e0e0;
            font-size: 24px;
            padding: 10px;
            border: none;
            cursor: pointer;
        }

        #prevSlide {
            left: 10px;
        }

        #nextSlide {
            right: 10px;
        }

        .slide-nav:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        .hidden {
            display: none;
        }

        .modal-logo {
            position: absolute;
            top: 20px;
            left: 20px;
            max-height: 150px;
            width: auto;
            z-index: 1200;
        }

        .back-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            color: #e0e0e0;
            cursor: pointer;
            z-index: 1200;
        }

        .back-button:hover {
            color: #1a73e8;
        }
    </style>
</head>
<body>
    <div class="logo" style="background: #1a73e8; color: white; padding: 10px 20px; border-radius: 4px; display: inline-block; font-weight: bold;">I_ROBOTICS</div>

    <div class="container">
        <button class="menu-button" id="menuButton" aria-label="Open Menu">☰</button>
        
        <div class="header-gif" style="background: linear-gradient(45deg, #1a73e8, #4285f4); width: 300px; height: 200px; margin: 0 auto; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; cursor: pointer; transition: opacity 0.3s ease;">
            Click here to start listening
        </div>
        
        <div class="voice-section">
            <h2>HI,HOW CAN I HELP YOU?</h2>
            <p id="transcript">Click the GIF above to start listening and ask your question...</p>
            <p id="response">Answer will appear here...</p>
        </div>

        <div class="qa-menu" id="qaMenu">
            <h2>Add New Question & Answer</h2>
            <form id="qaForm">
                <input type="text" id="questionInput" name="question" placeholder="Enter your question" required>
                <input type="text" id="answerInput" name="answer" placeholder="Enter the answer" required>
                <button type="submit">Add Q&A</button>
            </form>
            <p id="formFeedback"></p>

            <button id="editQaButton" class="edit-qa-button">Edit Q&A</button>
            <div id="qaList" class="qa-list hidden">
                <h3>Existing Q&As</h3>
                <div id="qaItems"></div>
            </div>

            <h2>Media Features</h2>
            <div id="dropArea" class="drop-area">
                Drag and drop video or image files here or click to select
                <input type="file" id="mediaInput" accept="video/*,image/*" multiple hidden>
            </div>
            <p id="mediaFeedback"></p>
            <h3>Videos</h3>
            <div id="videoList"></div>
            <h3>Images</h3>
            <div id="imageList"></div>
        </div>

        <div class="media-modal" id="mediaModal">
            <div class="modal-logo" style="background: #1a73e8; color: white; padding: 10px 20px; border-radius: 4px; display: inline-block; font-weight: bold; margin-bottom: 20px;">I_ROBOTICS</div>
            <button class="back-button" id="backButton" aria-label="Back">←</button>
            <div class="media-container">
                <video id="videoPlayer" controls autoplay loop>
                    <source id="videoSource" src="" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <div id="slideshow" class="slideshow hidden">
                    <img id="slideshowImage" src="" alt="Slideshow Image">
                    <button id="prevSlide" class="slide-nav">◄</button>
                    <button id="nextSlide" class="slide-nav">►</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const headerGif = document.querySelector('.header-gif');
        const transcript = document.getElementById('transcript');
        const response = document.getElementById('response');
        const qaForm = document.getElementById('qaForm');
        const formFeedback = document.getElementById('formFeedback');
        const menuButton = document.getElementById('menuButton');
        const qaMenu = document.getElementById('qaMenu');
        const dropArea = document.getElementById('dropArea');
        const mediaInput = document.getElementById('mediaInput');
        const mediaFeedback = document.getElementById('mediaFeedback');
        const videoList = document.getElementById('videoList');
        const imageList = document.getElementById('imageList');
        const mediaModal = document.getElementById('mediaModal');
        const backButton = document.getElementById('backButton');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoSource = document.getElementById('videoSource');
        const slideshow = document.getElementById('slideshow');
        const slideshowImage = document.getElementById('slideshowImage');
        const prevSlide = document.getElementById('prevSlide');
        const nextSlide = document.getElementById('nextSlide');
        const editQaButton = document.getElementById('editQaButton');
        const qaList = document.getElementById('qaList');
        const qaItems = document.getElementById('qaItems');

        let videos = [];
        let images = [];
        let qas = [];
        let slideshowInterval = null;
        let currentSlideIndex = 0;
        let isListening = false;

        async function loadQAs() {
            try {
                const res = await fetch('/get_qas');
                const data = await res.json();
                if (data.status === 'success') {
                    qas = data.qas;
                    console.log('Loaded Q&As:', qas);
                    renderQaList();
                } else {
                    console.error('Error fetching Q&As:', data.message);
                    formFeedback.textContent = data.message || 'Error fetching Q&As.';
                    formFeedback.style.color = 'red';
                }
            } catch (error) {
                console.error('Error fetching Q&As:', error);
                formFeedback.textContent = 'Error fetching Q&As: ' + error.message;
                formFeedback.style.color = 'red';
            }
        }

        function renderQaList() {
            qaItems.innerHTML = '';
            qas.forEach((qa) => {
                // Skip rendering if qa lacks required fields
                if (!qa.id || !qa.question || !qa.answer) {
                    console.warn('Skipping invalid Q&A entry:', qa);
                    return;
                }
                const qaItem = document.createElement('div');
                qaItem.className = 'qa-item';
                qaItem.innerHTML = `
                    <span><strong>Q:</strong> ${qa.question}</span>
                    <span><strong>A:</strong> ${qa.answer}</span>
                    <div class="qa-actions">
                        <button class="edit-qa" data-id="${qa.id}">Edit</button>
                        <button class="delete-qa" data-id="${qa.id}">Delete</button>
                    </div>
                `;
                qaItems.appendChild(qaItem);
            });
            attachQaEventListeners();
        }

        function attachQaEventListeners() {
            document.querySelectorAll('.edit-qa').forEach(button => {
                button.addEventListener('click', () => {
                    const qaId = button.dataset.id;
                    const qaItem = button.closest('.qa-item');
                    const qa = qas.find(q => q.id === qaId);
                    if (qa) {
                        qaItem.innerHTML = `
                            <input type="text" class="edit-question" value="${qa.question}" required>
                            <input type="text" class="edit-answer" value="${qa.answer}" required>
                            <div class="qa-actions">
                                <button class="save-qa" data-id="${qa.id}">Save</button>
                                <button class="cancel-qa" data-id="${qa.id}">Cancel</button>
                            </div>
                        `;
                        attachEditQaListeners(qaItem);
                    } else {
                        console.error('Q&A not found for ID:', qaId);
                        formFeedback.textContent = 'Error: Q&A not found.';
                        formFeedback.style.color = 'red';
                    }
                });
            });

            document.querySelectorAll('.delete-qa').forEach(button => {
                button.addEventListener('click', async () => {
                    if (confirm('Are you sure you want to delete this Q&A?')) {
                        const qaId = button.dataset.id;
                        try {
                            const res = await fetch(`/delete_qa/${qaId}`, {
                                method: 'DELETE'
                            });
                            const data = await res.json();
                            if (data.status === 'success') {
                                qas = qas.filter(q => q.id !== qaId);
                                renderQaList();
                                formFeedback.textContent = 'Q&A deleted successfully!';
                                formFeedback.style.color = 'green';
                                setTimeout(() => { formFeedback.textContent = ''; }, 3000);
                            } else {
                                console.error('Error deleting Q&A:', data.message);
                                formFeedback.textContent = data.message;
                                formFeedback.style.color = 'red';
                            }
                        } catch (error) {
                            console.error('Error deleting Q&A:', error);
                            formFeedback.textContent = 'Error deleting Q&A.';
                            formFeedback.style.color = 'red';
                        }
                    }
                });
            });
        }

        function attachEditQaListeners(qaItem) {
            const saveButton = qaItem.querySelector('.save-qa');
            const cancelButton = qaItem.querySelector('.cancel-qa');
            const qaId = saveButton.dataset.id;

            saveButton.addEventListener('click', async () => {
                const newQuestion = qaItem.querySelector('.edit-question').value.trim();
                const newAnswer = qaItem.querySelector('.edit-answer').value.trim();
                if (!newQuestion || !newAnswer) {
                    formFeedback.textContent = 'Question and answer cannot be empty.';
                    formFeedback.style.color = 'red';
                    return;
                }
                try {
                    const res = await fetch(`/update_qa/${qaId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question: newQuestion, answer: newAnswer })
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        const qa = qas.find(q => q.id === qaId);
                        if (qa) {
                            qa.question = newQuestion;
                            qa.answer = newAnswer;
                            renderQaList();
                            formFeedback.textContent = 'Q&A updated successfully!';
                            formFeedback.style.color = 'green';
                            setTimeout(() => { formFeedback.textContent = ''; }, 3000);
                        } else {
                            console.error('Q&A not found after update for ID:', qaId);
                            formFeedback.textContent = 'Error: Q&A not found.';
                            formFeedback.style.color = 'red';
                        }
                    } else {
                        console.error('Error updating Q&A:', data.message);
                        formFeedback.textContent = data.message;
                        formFeedback.style.color = 'red';
                    }
                } catch (error) {
                    console.error('Error updating Q&A:', error);
                    formFeedback.textContent = 'Error updating Q&A.';
                    formFeedback.style.color = 'red';
                }
            });

            cancelButton.addEventListener('click', () => {
                renderQaList();
            });
        }

        editQaButton.addEventListener('click', () => {
            qaList.classList.toggle('hidden');
        });

        async function loadVideos() {
            try {
                const res = await fetch('/get_videos');
                const data = await res.json();
                if (data.status === 'success') {
                    videos = data.videos;
                    console.log('Loaded videos:', videos);
                    renderVideoList();
                } else {
                    console.error('Error fetching videos:', data.message);
                    mediaFeedback.textContent = data.message || 'Error fetching videos.';
                    mediaFeedback.style.color = 'red';
                }
            } catch (error) {
                console.error('Error fetching videos:', error);
                mediaFeedback.textContent = 'Error fetching videos: ' + error.message;
                mediaFeedback.style.color = 'red';
            }
        }

        async function loadImages() {
            try {
                const res = await fetch('/get_images');
                const data = await res.json();
                if (data.status === 'success') {
                    images = data.images;
                    console.log('Loaded images:', images);
                    renderImageList();
                } else {
                    console.error('Error fetching images:', data.message);
                    mediaFeedback.textContent = data.message || 'Error fetching images.';
                    mediaFeedback.style.color = 'red';
                }
            } catch (error) {
                console.error('Error fetching images:', error);
                mediaFeedback.textContent = 'Error fetching images: ' + error.message;
                mediaFeedback.style.color = 'red';
            }
        }

        function renderVideoList() {
            videoList.innerHTML = '';
            videos.forEach((video) => {
                const videoItem = document.createElement('div');
                videoItem.className = 'media-item';
                videoItem.innerHTML = `
                    <span>${video.display_name}</span>
                    <div>
                        <button class="play-video" data-id="${video.id}" data-url="${video.url}">Play</button>
                        <button class="delete-media" data-id="${video.id}" data-type="video">Delete</button>
                    </div>
                `;
                videoList.appendChild(videoItem);
            });
            attachMediaEventListeners();
        }

        function renderImageList() {
            imageList.innerHTML = '';
            images.forEach((image) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'media-item';
                imageItem.innerHTML = `
                    <span>${image.display_name}</span>
                    <div>
                        <button class="view-slideshow" data-id="${image.id}" data-url="${image.url}">View Slideshow</button>
                        <button class="delete-media" data-id="${image.id}" data-type="image">Delete</button>
                    </div>
                `;
                imageList.appendChild(imageItem);
            });
            attachMediaEventListeners();
        }

        function attachMediaEventListeners() {
            document.querySelectorAll('.play-video').forEach(button => {
                button.addEventListener('click', () => {
                    const video = videos.find(v => v.id === button.dataset.id);
                    if (video) {
                        console.log('Playing video:', video.url);
                        videoPlayer.classList.remove('hidden');
                        slideshow.classList.add('hidden');
                        clearInterval(slideshowInterval);
                        videoSource.src = video.url;
                        videoPlayer.load();
                        videoPlayer.play().catch(error => {
                            console.error('Video playback error:', error);
                            mediaFeedback.textContent = 'Error playing video.';
                            mediaFeedback.style.color = 'red';
                        });
                        mediaModal.classList.add('open');
                        qaMenu.classList.remove('open');
                    } else {
                        console.error('Video not found for ID:', button.dataset.id);
                    }
                });
            });

            document.querySelectorAll('.view-slideshow').forEach(button => {
                button.addEventListener('click', () => {
                    console.log('Starting slideshow');
                    videoPlayer.classList.add('hidden');
                    slideshow.classList.remove('hidden');
                    startSlideshow();
                    mediaModal.classList.add('open');
                    qaMenu.classList.remove('open');
                });
            });

            document.querySelectorAll('.delete-media').forEach(button => {
                button.addEventListener('click', async () => {
                    if (confirm('Are you sure you want to delete this item?')) {
                        const type = button.dataset.type;
                        const id = button.dataset.id;
                        try {
                            const res = await fetch(`/delete_${type}/${id}`, {
                                method: 'DELETE'
                            });
                            const data = await res.json();
                            if (data.status === 'success') {
                                if (type === 'video') {
                                    videos = videos.filter(v => v.id !== id);
                                    renderVideoList();
                                } else {
                                    images = images.filter(i => i.id !== id);
                                    renderImageList();
                                }
                                mediaFeedback.textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully!`;
                                mediaFeedback.style.color = 'green';
                                setTimeout(() => { mediaFeedback.textContent = ''; }, 3000);
                            } else {
                                mediaFeedback.textContent = data.message;
                                mediaFeedback.style.color = 'red';
                            }
                        } catch (error) {
                            console.error(`Error deleting ${type}:`, error);
                            mediaFeedback.textContent = `Error deleting ${type}.`;
                            mediaFeedback.style.color = 'red';
                        }
                    }
                });
            });
        }

        function startSlideshow() {
            if (images.length === 0) {
                console.log('No images for slideshow');
                return;
            }
            currentSlideIndex = 0;
            showSlide(currentSlideIndex);
            slideshowInterval = setInterval(() => {
                currentSlideIndex = (currentSlideIndex + 1) % images.length;
                showSlide(currentSlideIndex);
            }, 3000);
        }

        function showSlide(index) {
            const image = images[index];
            slideshowImage.src = image.url;
            slideshowImage.alt = image.display_name;
            console.log('Showing slide:', image.url);
        }

        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('dragover');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('dragover');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        dropArea.addEventListener('click', () => mediaInput.click());

        mediaInput.addEventListener('change', () => handleFiles(mediaInput.files));

        async function handleFiles(files) {
            const videoFiles = Array.from(files).filter(file => file.type.startsWith('video/'));
            const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
            if (videoFiles.length === 0 && imageFiles.length === 0) {
                mediaFeedback.textContent = 'Please drop valid video or image files.';
                mediaFeedback.style.color = 'red';
                return;
            }
            for (const file of videoFiles) {
                const formData = new FormData();
                formData.append('video', file);
                try {
                    const res = await fetch('/upload_video', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        videos.push({ id: data.filename, display_name: data.display_name, url: data.url });
                        renderVideoList();
                        mediaFeedback.textContent = data.message;
                        mediaFeedback.style.color = 'green';
                    } else {
                        mediaFeedback.textContent = data.message;
                        mediaFeedback.style.color = 'red';
                    }
                    setTimeout(() => { mediaFeedback.textContent = ''; }, 3000);
                } catch (error) {
                    console.error('Error uploading video:', error);
                    mediaFeedback.textContent = 'Error uploading video.';
                    mediaFeedback.style.color = 'red';
                }
            }
            for (const file of imageFiles) {
                const formData = new FormData();
                formData.append('image', file);
                try {
                    const res = await fetch('/upload_image', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        images.push({ id: data.filename, display_name: data.display_name, url: data.url });
                        renderImageList();
                        mediaFeedback.textContent = data.message;
                        mediaFeedback.style.color = 'green';
                    } else {
                        mediaFeedback.textContent = data.message;
                        mediaFeedback.style.color = 'red';
                    }
                    setTimeout(() => { mediaFeedback.textContent = ''; }, 3000);
                } catch (error) {
                    console.error('Error uploading image:', error);
                    mediaFeedback.textContent = 'Error uploading image.';
                    mediaFeedback.style.color = 'red';
                }
            }
            mediaInput.value = '';
        }

        menuButton.addEventListener('click', () => {
            qaMenu.classList.toggle('open');
            mediaModal.classList.remove('open');
        });

        qaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(qaForm);
            try {
                const res = await fetch('/add_qa', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                formFeedback.textContent = data.message;
                formFeedback.style.color = data.status === 'success' ? 'green' : 'red';
                if (data.status === 'success') {
                    qaForm.reset();
                    await loadQAs();
                    setTimeout(() => { formFeedback.textContent = ''; }, 3000);
                }
            } catch (error) {
                console.error('Error adding Q&A:', error);
                formFeedback.textContent = 'Failed to add Q&A. Please try again.';
                formFeedback.style.color = 'red';
            }
        });

        backButton.addEventListener('click', () => {
            mediaModal.classList.remove('open');
            videoPlayer.pause();
            videoSource.src = '';
            clearInterval(slideshowInterval);
        });

        prevSlide.addEventListener('click', () => {
            if (images.length === 0) return;
            currentSlideIndex = (currentSlideIndex - 1 + images.length) % images.length;
            showSlide(currentSlideIndex);
            resetSlideshowInterval();
        });

        nextSlide.addEventListener('click', () => {
            if (images.length === 0) return;
            currentSlideIndex = (currentSlideIndex + 1) % images.length;
            showSlide(currentSlideIndex);
            resetSlideshowInterval();
        });

        function resetSlideshowInterval() {
            clearInterval(slideshowInterval);
            slideshowInterval = setInterval(() => {
                currentSlideIndex = (currentSlideIndex + 1) % images.length;
                showSlide(currentSlideIndex);
            }, 3000);
        }

        let recognition;
        if (window.SpeechRecognition || window.webkitSpeechRecognition) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            console.log('SpeechRecognition initialized');

            headerGif.addEventListener('click', () => {
                if (!isListening) {
                    try {
                        recognition.start();
                        console.log('Speech recognition started');
                        transcript.textContent = 'Listening for your question...';
                        isListening = true;
                        headerGif.classList.add('listening');
                    } catch (error) {
                        console.error('Error starting speech recognition:', error);
                        transcript.textContent = 'Error starting speech recognition: ' + error.message;
                        isListening = false;
                        headerGif.classList.remove('listening');
                    }
                } else {
                    try {
                        recognition.stop();
                        console.log('Speech recognition stopped');
                        transcript.textContent = 'Click the GIF above to start listening and ask your question...';
                        isListening = false;
                        headerGif.classList.remove('listening');
                    } catch (error) {
                        console.error('Error stopping speech recognition:', error);
                    }
                }
            });

            function getFemaleVoice() {
                const voices = window.speechSynthesis.getVoices();
                console.log('Available voices:', voices.map(v => ({ name: v.name, lang: v.lang })));
                const femaleVoice = voices.find(voice => 
                    voice.name.includes('Google US English Female') ||
                    voice.name.includes('Microsoft Zira') ||
                    voice.name.includes('Samantha') ||
                    voice.name.includes('Victoria') ||
                    voice.name.includes('Tessa') ||
                    (voice.lang === 'en-US' && voice.name.toLowerCase().includes('female'))
                );
                return femaleVoice || voices.find(v => v.lang === 'en-US') || voices[0];
            }

            recognition.onresult = async (event) => {
                const question = event.results[0][0].transcript;
                transcript.textContent = `You asked: ${question}`;
                isListening = false;
                headerGif.classList.remove('listening');
                console.log('Recognized question:', question);
                try {
                    const res = await fetch('/get_answer', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ question })
                    });
                    const data = await res.json();
                    response.textContent = `Answer: ${data.answer}`;
                    const utterance = new SpeechSynthesisUtterance(data.answer);
                    utterance.lang = 'en-US';
                    if (window.speechSynthesis.getVoices().length === 0) {
                        window.speechSynthesis.onvoiceschanged = () => {
                            const selectedVoice = getFemaleVoice();
                            console.log('Selected voice:', selectedVoice ? selectedVoice.name : 'None');
                            utterance.voice = selectedVoice;
                            window.speechSynthesis.speak(utterance);
                        };
                    } else {
                        const selectedVoice = getFemaleVoice();
                        console.log('Selected voice:', selectedVoice ? selectedVoice.name : 'None');
                        utterance.voice = selectedVoice;
                        window.speechSynthesis.speak(utterance);
                    }
                } catch (error) {
                    console.error('Error getting answer:', error);
                    response.textContent = 'Error getting answer. Please try again.';
                }
            };

            recognition.onend = () => {
                console.log('Speech recognition ended');
                isListening = false;
                headerGif.classList.remove('listening');
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                transcript.textContent = 'Error occurred in recognition: ' + event.error;
                isListening = false;
                headerGif.classList.remove('listening');
                if (event.error === 'no-speech') {
                    transcript.textContent = 'No speech detected. Please try again.';
                } else if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                    transcript.textContent = 'Microphone access denied. Please allow microphone permissions.';
                } else if (event.error === 'network') {
                    transcript.textContent = 'Network error. Please check your internet connection.';
                }
            };
        } else {
            console.error('SpeechRecognition not supported in this browser');
            transcript.textContent = 'Speech recognition is not supported in this browser. Please use Chrome or Edge.';
            headerGif.style.cursor = 'not-allowed';
            headerGif.style.opacity = '0.5';
        }

        loadVideos();
        loadImages();
        loadQAs();
    </script>
</body>
</html>